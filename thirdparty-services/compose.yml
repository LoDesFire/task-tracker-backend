services:
  localstack:
    container_name: "${LOCALSTACK_DOCKER_NAME:-localstack-main}"
    image: localstack/localstack
    ports:
      - "127.0.0.1:4566:4566"            # LocalStack Gateway
      - "127.0.0.1:4510-4559:4510-4559"  # external services port range
    environment:
      - DEBUG=${DEBUG:-0}
      - SERVICES=s3,ses
    volumes:
      - "${LOCALSTACK_VOLUME_DIR:-./data/localstack}:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      default:
      third-party-services-net:
        ipv4_address: 172.23.0.2
  localstack-loader:
    image: highfive/aws
    restart: on-failure
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
    command: --endpoint-url http://localstack:4566 ses verify-email-identity --email no-reply@example.com --region us-east-1
    depends_on:
      - localstack
    networks:
      - default


  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    networks:
      default:
      third-party-services-net:
        ipv4_address: 172.23.0.3
  kafka:
    image: confluentinc/cp-kafka:7.4.3
    depends_on:
      - zookeeper
    ports:
      - '9094:9094'
    expose:
      - "9092"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://172.23.0.4:9092,PLAINTEXT_HOST://localhost:9094
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: '1'
      KAFKA_MIN_INSYNC_REPLICAS: '1'
    networks:
      third-party-services-net:
        ipv4_address: 172.23.0.4

  db:
    image: postgres
    restart: always
    user: postgres
    networks:
      third-party-services-net:
        ipv4_address: 172.23.0.5
    volumes:
      - db-data:/var/lib/postgresql/data
    env_file:
      - .docker.postgres.env
    ports:
      - "5430:5432"
    healthcheck:
      test: [ "CMD", "pg_isready" ]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis
    container_name: redis
    command: /bin/sh -c "redis-server --requirepass $$REDIS_PASSWORD"
    networks:
      third-party-services-net:
        ipv4_address: 172.23.0.6
    volumes:
      - redis:/var/lib/redis/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    ports:
      - "6378:6379"
    env_file:
      - .docker.redis.env

  minio:
    image: quay.io/minio/minio
    container_name: minio
    ports:
      - "9000:9000"
      - "9090:9090"
    volumes:
      - "./data/minio:/data"
    env_file:
      - .docker.minio.env
    command: server /data --console-address ":9090"
    networks:
      third-party-services-net:
        ipv4_address: 172.23.0.7

  mongodb:
    image: mongo
    container_name: mongo-db
    env_file:
      - .docker.mongo.env
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db



volumes:
  mongo_data:
  kafka_data:
    driver: local
  redis:
  db-data:


networks:
  third-party-services-net:
    ipam:
      driver: default
      config:
        - subnet: 172.23.0.0/16